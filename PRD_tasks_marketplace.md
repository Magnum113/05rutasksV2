# PRD: Фича «Задания» для 05.ru

## 1. Контекст и цель

«Задания» — игровой элемент в `05.ru`, который стимулирует пользователей совершать целевые действия (например, добавить товар в корзину, посетить страницу, сделать покупку).

За выполнение задания пользователь получает награду:

- бонусы;
- промокод;
- очки активности;
- комбинации наград (например, бонусы + очки активности, промокод + очки активности).

Цель фичи: повысить вовлечённость пользователей, увеличить продажи и частоту взаимодействия с платформой.

## 2. Scope текущей реализации

- В текущем этапе реализуется механика «Задания».
- Frontend-часть «Розыгрышей» не реализуется.
- Backend и админка по очкам активности реализуются как подготовка к будущим розыгрышам.

## 3. Платформа и доступ

- Реализация интерфейса заданий: web-версия `05.ru`.
- В web-профиле должен быть вход в фичу через вкладку `Задания`.
- В мобильном приложении в профиле должен быть вход через вкладку `Задания` с открытием webview страницы заданий.
- Для доступа к заданиям обязательна авторизация пользователя.

## 4. Функциональные требования

### 4.1. Структура задания

Для каждого задания должны поддерживаться поля:

- код задания (`task_code`), по которому в `1С` выполняется начисление бонусов;
- заголовок;
- описание;
- изображение/лого;
- период активности задания (`active_from`, `active_to`);
- статус задания;
- тип награды и параметры награды;
- ссылка кнопки для перехода к выполнению;
- приоритет в списке;
- период покупок для purchase-заданий (`purchase_period_from`, `purchase_period_to`) как фиксированный диапазон дат;
- для промокодной награды: идентификатор/код промокода, срок действия и условия (текстовые поля);
- для очков активности: количество очков и срок сгорания очков;
- фиксированное окно получения награды после завершения срока задания: `7` дней.

### 4.2. Статусы задания

Модель статусов задания:

- `upcoming` — задание ещё не началось;
- `active` — задание активно;
- `completed` — условие задания выполнено, награда ещё не получена;
- `reward_claimed` — награда получена;
- `expired` — срок активности задания завершён; для `completed` без получения награды статус наступает после окончания 7-дневного окна получения.

### 4.3. Логика выполнения

- Задание начинает учитываться автоматически, вручную запускать его не нужно.
- Если пользователь выполнил условие во время активности задания, задание должно перейти в `completed` даже если пользователь не открывал страницу «Задания».
- Каждое задание одноразовое.
- Награда по одному заданию может быть получена только один раз.
- Если задание выполнено, но не забрано, оно остаётся доступным для получения награды ещё `7` дней после завершения срока задания.
- По истечении этих `7` дней получение награды недоступно.

### 4.4. Отображение и кнопки

- Для `upcoming` показывается обратный отсчёт до старта.
- Для `active` показывается оставшийся срок выполнения.
- Для `active` используется кнопка «Перейти к выполнению».
- Для `completed` используется кнопка «Забрать награду».
- Если срок задания закончился, но у пользователя статус `completed`, задание продолжает отображаться `7` дней с кнопкой «Забрать награду».
- Для `reward_claimed` задание отображается как завершённое с полученной наградой.
- Кнопка «Начать задание» не используется.

### 4.5. Награды

Поддерживаемые типы наград:

- бонусы;
- промокоды;
- очки активности;
- комбинации: бонусы + очки активности, промокод + очки активности.

Правила наград:

- бонусы начисляются после нажатия «Забрать награду»;
- промокоды являются общими (не персональными);
- при настройке задания в админке маркетолог вводит идентификатор/код промокода и условия (промокод создаётся заранее вне фичи заданий);
- для промокодов в карточке отображаются код/идентификатор, срок действия и условия;
- выдача награды должна быть идемпотентной: повторное получение по уже полученному заданию запрещено;
- проверка на повторную выдачу выполняется по пользователю и коду задания.

### 4.6. Приоритет и сортировка

- Сначала сортировка по приоритету (более высокий приоритет выше).
- При равном приоритете выше показываются более новые задания.

### 4.7. Типы заданий

1. Добавить определённое количество товаров в корзину.
2. Добавить определённое количество товаров в избранное.
3. Совершить покупку на определённую сумму.
4. Совершить покупку из определённой категории (и на определённую сумму).
5. Совершить покупку товаров от определённого продавца (и на определённую сумму).
6. Посетить определённый URL.
7. Посетить определённый экран в приложении.
8. Посетить сторонний URL.

Правила проверки выполнения:

- Для всех типов заданий нужна проверка факта выполнения.
- Для заданий на покупки учитываются только покупки со статусом `получен`.
- Возвраты не учитываются.
- Для purchase-заданий используется фиксированный период покупок, заданный в админке при создании задания.
- Для остальных типов заданий условия выполняются в период активности задания.
- Для заданий типа `6` и `8` критерием выполнения является факт открытия URL.
- Задание типа `7` (экран приложения) также должно поддерживаться.

## 5. Очки активности

Очки активности — виртуальные очки для будущих механик розыгрышей.

Требования:

- начисление очков активности по выполненным заданиям;
- хранение очков активности на стороне backend;
- суммирование очков по всем заданиям пользователя;
- выдача в API количества доступных (актуальных) очков;
- срок сгорания очков задаётся в настройках задания;
- после наступления срока сгорания очки не должны учитываться в доступном балансе;
- у задания может не быть очков активности.


## 6. Back-end требования

- Реализовать модель данных заданий и статусов.
- Реализовать проверку выполнения всех типов заданий
- Реализовать автоматический учёт выполнения условий заданий.
- Реализовать одноразовость выполнения и одноразовость выдачи награды.
- Реализовать проверку повторной выдачи награды по пользователю и `task_code`.
- Для purchase-заданий учитывать только покупки со статусом `получен` в заданном диапазоне дат.
- Реализовать начисление бонусов через `1С` по коду задания.
- Реализовать подсистему очков активности: начисление, хранение, сгорание, агрегирование.
- Отдать в API данные для списка заданий, статусов, наград, получения награды и общего количества доступных очков.

## 7. Front-end требования

### 7.1. Web Front-end

- Перенести дизайн фичи из интернет магазина с использованием шрифтов маркетплейса.
- Реализовать страницу заданий в web.
- В профиле web добавить вкладку `Задания` как переход к странице заданий.
- Требовать авторизацию при входе в фичу заданий.
- Отрисовать карточки заданий, статусы, сроки/таймеры, кнопки действий, отображение наград.
- Реализовать UI только для механики «Задания».

### 7.2. ТЗ по аналитике для Front-end (dataLayer)

Ниже фиксируется контракт для фронтенда: какие события и с какими параметрами пушить в `dataLayer`.

#### 7.2.1. Базовый формат события

Каждый `dataLayer.push` должен содержать базовые поля:

- `event` — имя события;
- `feature` — всегда `tasks`;
- `event_ts` — timestamp в ISO-формате.

Базовый пример:

```js
window.dataLayer = window.dataLayer || [];
window.dataLayer.push({
  event: "tasks_page_view",
  feature: "tasks",
  event_ts: "2026-02-12T21:30:00Z"
});
```

#### 7.2.2. Справочники параметров

`task_type`:

- `add_to_cart`
- `add_to_favorites`
- `purchase_amount`
- `purchase_category`
- `purchase_seller`
- `visit_url`
- `visit_app_screen`
- `visit_external_url`

`task_status`:

- `upcoming`
- `active`
- `completed`
- `reward_claimed`
- `expired`

`reward_types`:

- `bonus`
- `promocode`
- `activity_points`

`cta_type`:

- `go_to_action`
- `claim_reward`

#### 7.2.3. Список событий для фронтенда

1. `tasks_page_view`  
Когда: пользователь открыл страницу заданий.  
Параметры:
- `tasks_total`
- `tasks_active_count`
- `tasks_completed_count`
- `tasks_completed_unclaimed_count`
- `points_balance_available`

2. `tasks_auth_required`  
Когда: пользователь без авторизации пытается открыть страницу заданий.  
Параметры:
- `auth_gate`: `tasks_page`

3. `task_card_impression`  
Когда: карточка задания впервые попала во viewport (1 раз на карточку за page view).  
Параметры:
- `task_id`
- `task_code`
- `task_type`
- `task_status`
- `task_priority`
- `card_position`
- `reward_types`
- `active_from`
- `active_to`

4. `task_card_click`  
Когда: клик по карточке задания (если карточка кликабельна отдельно от CTA).  
Параметры:
- `task_id`
- `task_code`
- `task_type`
- `task_status`
- `card_position`

5. `task_cta_click`  
Когда: клик по CTA в карточке (`Перейти к выполнению`/`Забрать награду`).  
Параметры:
- `task_id`
- `task_code`
- `task_type`
- `task_status`
- `cta_type`
- `reward_types`

6. `task_redirect_open`  
Когда: после `task_cta_click` с `cta_type=go_to_action` пользователь отправлен по целевой ссылке/действию.  
Параметры:
- `task_id`
- `task_code`
- `task_type`
- `target_type`: `internal_url|external_url|app_screen`
- `target_value`

7. `task_claim_click`  
Когда: пользователь нажал `Забрать награду`.  
Параметры:
- `task_id`
- `task_code`
- `task_type`
- `reward_types`

8. `task_claim_success`  
Когда: награда успешно выдана.  
Параметры:
- `task_id`
- `task_code`
- `task_type`
- `reward_types`
- `points_amount` (если есть)
- `promocode_code` (если есть)

9. `task_claim_window_view`  
Когда: пользователь видит задание в статусе `completed` после завершения срока задания (в 7-дневном окне).  
Параметры:
- `task_id`
- `task_code`
- `task_type`
- `days_left_to_claim`

10. `task_claim_window_expired_view`  
Когда: задание перешло в `expired` после завершения 7-дневного окна и отображается как недоступное к получению награды.  
Параметры:
- `task_id`
- `task_code`
- `task_type`

11. `activity_points_view`  
Когда: на странице показан блок/значение очков активности пользователя.  
Параметры:
- `points_balance_available`

12. `activity_points_expiring_view`  
Когда: показана информация о скором сгорании очков (если такой UI-блок есть).  
Параметры:
- `points_expiring_soon`
- `expiry_nearest_date`

#### 7.2.4. Правила отправки событий

- События отправляются только по факту действия/показа, без синтетических дублей.
- `task_card_impression`: 1 раз на карточку за один просмотр страницы.
- На каждую попытку `task_claim_click` должен приходить финальный исход `task_claim_success`.

Ссылка на макеты:

- [Макеты в Figma](https://www.figma.com/design/dBQPhIdrbgtC7DiX0byArv/%D0%93%D0%B8%D0%BF%D0%BE%D1%82%D0%B5%D0%B7%D0%B0-%D0%97%D0%B0%D0%B4%D0%B0%D0%BD%D0%B8%D1%8F-%7C-%D0%A2%D0%97-%D0%B4%D0%BB%D1%8F-Front-end?node-id=0-1&t=SysQ2XkMiHPFiA5b-1)

## 8. ТЗ для разработчиков мобильного приложения

- В профиле мобильного приложения добавить вкладку `Задания`.
- При переходе по вкладке `Задания` открывать webview страницы с заданиями.
- Макеты для размещения вкладки и перехода использовать из файла Figma по ссылке выше.

## 9. Админ-панель

В админке требуется:

- создание и редактирование заданий;
- настройка заголовка, описания, изображения;
- настройка типа задания;
- настройка периода активности задания;
- настройка фиксированного периода покупок для purchase-заданий;
- настройка типа награды и параметров награды;
- для промокодов: ввод идентификатора/кода, срока действия и условий;
- для очков активности: настройка количества очков и срока сгорания;
- настройка ссылки кнопки;
- настройка приоритета;
- управление статусами заданий;
- просмотр выполнения заданий пользователями;
- просмотр списка пользователей, их очков активности и номеров телефонов.

## 10. Критерии готовности

Фича считается реализованной, если:

- авторизованный пользователь видит список заданий с корректной сортировкой;
- статусы заданий работают по модели `upcoming/active/completed/reward_claimed/expired`;
- задание выполняется автоматически по факту действий пользователя;
- поддержаны все типы заданий `1-8`;
- для URL-заданий (`6`, `8`) выполнение фиксируется по факту открытия URL;
- для purchase-заданий учитываются только покупки со статусом `получен` и только в заданном периоде;
- каждое задание одноразовое и награда может быть получена только один раз;
- реализована защита от повторной выдачи награды по пользователю и коду задания;
- выполненное, но не забранное задание отображается ещё `7` дней после окончания срока задания;
- по истечении `7` дней после окончания срока задания награда по незабранному заданию больше не выдаётся;
- очки активности начисляются, суммируются, сгорают по сроку и отдаются в API как доступный баланс;
- админка позволяет полностью настраивать задания и видеть список пользователей с очками активности;
- в web-профиле реализована вкладка `Задания` с переходом к странице фичи;
- в мобильном профиле реализована вкладка `Задания`, открывающая webview страницы заданий;
- фронтенд отправляет в `dataLayer` события аналитики из раздела 7.2.

## 11. Метрики успеха фичи

### 11.1. Основные продуктовые метрики

1. Reach страницы заданий  
Формула: `Users с event=tasks_page_view / Все авторизованные пользователи web за период`.

2. Activation в заданиях  
Формула: `Users с >=1 просмотром карточки активного задания / Users с tasks_page_view`.

3. Completion Rate (по пользователям)  
Формула: `Users с >=1 выполненным заданием / Users с >=1 активным заданием`.

4. Completion Rate (по заданию)  
Формула: `Кол-во пользователей, выполнивших конкретное задание / Кол-во пользователей, которым задание было показано`.

5. Reward Claim Rate  
Формула: `Кол-во полученных наград / Кол-во выполненных заданий`.

6. Claim Within 7 Days  
Формула: `Кол-во наград, забранных в 7-дневное окно / Кол-во выполненных заданий`.

7. Median Time to Claim  
Формула: медианное время от первого статуса `completed` до `reward_claimed`.

8. Participation in Purchase Tasks  
Формула: `Users, выполнившие >=1 purchase-задание / Users, видевшие purchase-задания`.

9. Activity Points Adoption  
Формула: `Users с доступными очками активности > 0 / Users с tasks_page_view`.

### 11.2. Бизнес-метрики эффекта

1. Конверсия в заказ среди участников заданий  
Сравнение CVR пользователей, которые взаимодействовали с заданиями, с контрольной/базовой группой.

2. Среднее число заказов на пользователя (Orders per User) у участников заданий.

3. GMV от пользователей, выполнивших purchase-задания.

4. Доля заказов с выполнением целевого задания (атрибуция на период активности задания).
